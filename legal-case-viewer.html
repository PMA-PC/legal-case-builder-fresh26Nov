<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Case Questions Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .markdown-body h1 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .markdown-body h2 {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 0.5em;
            margin-top: 1em;
        }

        .markdown-body p {
            margin-bottom: 1em;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body strong {
            font-weight: bold;
        }

        .prose :where(ul):not(:where([class~="not-prose"] *)) {
            list-style-type: disc;
            padding-left: 1.5em;
        }

        .prose :where(ol):not(:where([class~="not-prose"] *)) {
            list-style-type: decimal;
            padding-left: 1.5em;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg flex flex-col z-10">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <i data-lucide="scale" class="w-6 h-6"></i>
                    Legal Case Viewer
                </h1>
                <p class="text-xs text-gray-500 mt-1">Shipman v. GAINSCO</p>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                <button onclick="switchTab('questions')" id="tab-questions"
                    class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md bg-blue-50 text-blue-700">
                    <i data-lucide="file-question" class="w-4 h-4"></i>
                    Questions (160)
                </button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    Case Dashboard
                </button>
                <button onclick="switchTab('discovery')" id="tab-discovery"
                    class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                    <i data-lucide="search" class="w-4 h-4"></i>
                    Discovery Tracker
                </button>

                <div class="pt-4 mt-4 border-t border-gray-200">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                        Sections
                    </h3>
                    <div id="section-nav" class="space-y-1">
                        <!-- Section links will be injected here -->
                    </div>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <div class="mb-3">
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider block mb-1">Gemini API
                        Key</label>
                    <input type="password" id="api-key-input" placeholder="Enter API Key"
                        class="w-full px-2 py-1 text-xs border rounded focus:ring-blue-500 focus:border-blue-500"
                        onchange="saveApiKey(this.value)">
                </div>
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                        JS
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Joshua Shipman</p>
                        <p class="text-xs text-gray-500">Claimant</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto bg-gray-100 p-8" id="main-content">
            <!-- Questions Tab -->
            <div id="view-questions" class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Legal Questions Database</h2>
                        <p class="text-gray-500 mt-1">Comprehensive list of 160 legal questions and answers.</p>
                    </div>
                    <div class="flex gap-3">
                        <div class="relative">
                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Search questions..."
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button onclick="expandAll()"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium">
                            Expand All
                        </button>
                        <button onclick="collapseAll()"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium">
                            Collapse All
                        </button>
                        <button onclick="exportData()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Export
                        </button>
                    </div>
                </div>

                <div id="questions-container">
                    <!-- Questions will be injected here -->
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="view-dashboard" class="max-w-6xl mx-auto hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Case Dashboard</h2>
                        <p class="text-gray-500 mt-1">Overview of case timeline, evidence, and damages.</p>
                    </div>
                </div>
                <div id="dashboard-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Dashboard widgets will be injected here -->
                </div>
            </div>

            <!-- Discovery Tab -->
            <div id="view-discovery" class="max-w-4xl mx-auto hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Discovery Tracker</h2>
                        <p class="text-gray-500 mt-1">Track evidence needed from GAINSCO vs. what you have.</p>
                    </div>
                    <button onclick="generateDiscoveryLetter()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Generate Request Letter
                    </button>
                </div>
                <div id="discovery-container" class="space-y-6">
                    <!-- Discovery items will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let caseData = {};
        let discoveryData = JSON.parse(localStorage.getItem('discoveryData')) || {};
        let apiKey = localStorage.getItem('geminiApiKey') || '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (apiKey) document.getElementById('api-key-input').value = apiKey;
            await loadQuestions();
            await loadCaseData();
            lucide.createIcons();
        });

        function saveApiKey(key) {
            apiKey = key;
            localStorage.setItem('geminiApiKey', key);
            alert('API Key saved!');
        }

        async function loadQuestions() {
            try {
                const response = await fetch('public/assets/data/legal-questions.json');
                allQuestions = await response.json();
                renderQuestions(allQuestions);
                renderSectionNav(allQuestions);
                renderDiscoveryTracker();
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questions-container').innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg">
                        Error loading questions. Please ensure the server is running and file exists.
                    </div>
                `;
            }
        }

        async function loadCaseData() {
            try {
                const response = await fetch('public/assets/data/legal-case-data.json');
                caseData = await response.json();
                renderDashboard(caseData);
            } catch (error) {
                console.error('Error loading case data:', error);
            }
        }

        // --- Rendering ---

        function renderQuestions(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            const sections = questions.reduce((acc, q) => {
                if (!acc[q.section]) acc[q.section] = [];
                acc[q.section].push(q);
                return acc;
            }, {});

            for (const [section, sectionQuestions] of Object.entries(sections)) {
                const sectionEl = document.createElement('div');
                sectionEl.id = `section-${slugify(section)}`;
                sectionEl.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8';

                // Inject Texas Case Law if relevant
                const relevantCases = getRelevantCases(section);
                let casesHtml = '';
                if (relevantCases.length > 0) {
                    casesHtml = `
                        <div class="bg-slate-50 p-4 border-b border-gray-200">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Relevant Texas Case Law</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${relevantCases.map(c => `
                                    <div class="bg-white border border-slate-200 p-3 rounded shadow-sm">
                                        <div class="flex justify-between">
                                            <span class="font-bold text-slate-800 text-sm">${c.caseName}</span>
                                            <span class="text-green-600 text-xs font-bold">${c.relevanceScore}% Match</span>
                                        </div>
                                        <p class="text-xs text-slate-600 mt-1 line-clamp-2">${c.relevance}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                sectionEl.innerHTML = `
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" onclick="toggleSection(this)">
                        <h2 class="text-lg font-semibold text-gray-800">${section}</h2>
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${sectionQuestions.length} Qs</span>
                    </div>
                    ${casesHtml}
                    <div class="divide-y divide-gray-100">
                        ${sectionQuestions.map(q => {
                    const disc = discoveryData[q.id] || {};
                    return `
                            <div class="p-6 hover:bg-gray-50 transition-colors group" id="q-${q.id}">
                                <div class="flex justify-between items-start gap-4 mb-3">
                                    <div class="flex items-center gap-3">
                                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 font-bold rounded-lg text-sm">
                                            Q${q.id}
                                        </span>
                                        <h3 class="text-base font-medium text-gray-900">${q.question}</h3>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="analyzeAnswer('${q.id}')" class="p-2 text-purple-600 hover:bg-purple-50 rounded transition-all" title="Analyze with AI">
                                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="copyAnswer('${q.id}')" class="p-2 text-gray-400 hover:text-blue-600 transition-all" title="Copy Answer">
                                            <i data-lucide="copy" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="pl-11">
                                    <div class="prose prose-sm max-w-none text-gray-600 bg-gray-50 p-4 rounded-lg border border-gray-100 mb-3">
                                        ${marked.parse(q.answer || '')}
                                    </div>
                                    
                                    <!-- Discovery & Confidence Tools -->
                                    <div class="flex items-center justify-between text-xs text-gray-500 border-t border-gray-100 pt-3">
                                        <div class="flex items-center gap-4">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" ${disc.needDiscovery ? 'checked' : ''} onchange="toggleDiscovery('${q.id}', this.checked)" class="rounded text-blue-600">
                                                Need Discovery
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" ${disc.haveEvidence ? 'checked' : ''} onchange="toggleEvidence('${q.id}', this.checked)" class="rounded text-green-600">
                                                Have Evidence
                                            </label>
                                        </div>
                                        <div id="confidence-${q.id}" class="font-medium"></div>
                                    </div>
                                    <div id="ai-analysis-${q.id}" class="hidden mt-3 bg-purple-50 p-3 rounded border border-purple-100 text-sm"></div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                container.appendChild(sectionEl);
            }
            lucide.createIcons();
        }

        function renderSectionNav(questions) {
            const sections = [...new Set(questions.map(q => q.section))];
            const nav = document.getElementById('section-nav');
            nav.innerHTML = sections.map(s => `
                <a href="#section-${slugify(s)}" class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md truncate" title="${s}">
                    ${s}
                </a>
            `).join('');
        }

        function renderDashboard(data) {
            const container = document.getElementById('dashboard-container');
            if (!data.timeline) return;

            // Timeline Widget
            const timelineHtml = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-blue-600"></i> Key Timeline Events
                    </h3>
                    <div class="space-y-4">
                        ${data.timeline.slice(0, 5).map(e => `
                            <div class="flex gap-4">
                                <div class="w-24 flex-shrink-0 text-sm font-bold text-gray-500">${new Date(e.date).toLocaleDateString()}</div>
                                <div>
                                    <div class="font-semibold text-gray-900">${e.type}</div>
                                    <div class="text-sm text-gray-600">${e.event}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Damages Widget
            const damagesHtml = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="dollar-sign" class="w-5 h-5 text-green-600"></i> Estimated Damages
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between border-b border-gray-100 pb-2">
                            <span class="text-gray-600">Lost Wages (Back Pay)</span>
                            <span class="font-bold">$19,896</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 pb-2">
                            <span class="text-gray-600">Front Pay (1 Year)</span>
                            <span class="font-bold">$119,376</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 pb-2">
                            <span class="text-gray-600">Compensatory</span>
                            <span class="font-bold">$300,000</span>
                        </div>
                        <div class="flex justify-between pt-2 text-lg">
                            <span class="font-bold text-gray-900">Total Estimate</span>
                            <span class="font-bold text-green-700">$439,272</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = timelineHtml + damagesHtml;
            lucide.createIcons();
        }

        function renderDiscoveryTracker() {
            const container = document.getElementById('discovery-container');
            const neededIds = Object.keys(discoveryData).filter(id => discoveryData[id].needDiscovery);

            if (neededIds.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500">No discovery items marked yet. Go to Questions tab and check "Need Discovery".</div>`;
                return;
            }

            container.innerHTML = neededIds.map(id => {
                const q = allQuestions.find(q => q.id == id);
                const notes = discoveryData[id].notes || '';
                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-gray-900">Q${id}: ${q.question}</h4>
                            <button onclick="toggleDiscovery('${id}', false); renderDiscoveryTracker()" class="text-red-500 hover:text-red-700 text-xs">Remove</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded">${q.answer.substring(0, 150)}...</p>
                        <textarea placeholder="Discovery Notes: What document do you need? Who has it?" 
                            class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            rows="2" onchange="saveDiscoveryNotes('${id}', this.value)">${notes}</textarea>
                    </div>
                `;
            }).join('');
        }

        // --- Logic & AI ---

        function switchTab(tab) {
            ['questions', 'dashboard', 'discovery'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('bg-blue-50', 'text-blue-700');
                document.getElementById(`tab-${t}`).classList.add('text-gray-600');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('bg-blue-50', 'text-blue-700');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-600');

            if (tab === 'discovery') renderDiscoveryTracker();
        }

        function toggleDiscovery(id, checked) {
            if (!discoveryData[id]) discoveryData[id] = {};
            discoveryData[id].needDiscovery = checked;
            localStorage.setItem('discoveryData', JSON.stringify(discoveryData));
        }

        function toggleEvidence(id, checked) {
            if (!discoveryData[id]) discoveryData[id] = {};
            discoveryData[id].haveEvidence = checked;
            localStorage.setItem('discoveryData', JSON.stringify(discoveryData));
        }

        function saveDiscoveryNotes(id, notes) {
            if (!discoveryData[id]) discoveryData[id] = {};
            discoveryData[id].notes = notes;
            localStorage.setItem('discoveryData', JSON.stringify(discoveryData));
        }

        async function analyzeAnswer(id) {
            if (!apiKey) {
                alert('Please enter your Gemini API Key in the sidebar first.');
                return;
            }

            const q = allQuestions.find(q => q.id == id);
            const analysisDiv = document.getElementById(`ai-analysis-${id}`);
            const confidenceDiv = document.getElementById(`confidence-${id}`);

            analysisDiv.innerHTML = '<div class="flex items-center gap-2"><i data-lucide="loader" class="animate-spin w-4 h-4"></i> Analyzing...</div>';
            analysisDiv.classList.remove('hidden');

            try {
                const prompt = `
                    Analyze this legal Q&A for a wrongful termination case (Texas law).
                    Question: "${q.question}"
                    Answer: "${q.answer}"
                    
                    Return JSON with:
                    1. confidence_score (0-100)
                    2. analysis (brief critique)
                    3. missing_evidence (what proof is needed)
                    4. follow_up_questions (array of 2 strings)
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                // Simple parsing assuming JSON is returned (in production use structured output)
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                const result = jsonMatch ? JSON.parse(jsonMatch[0]) : { confidence_score: 50, analysis: text };

                // Update UI
                const score = result.confidence_score || 0;
                let color = score >= 85 ? 'text-green-600' : (score >= 70 ? 'text-yellow-600' : 'text-red-600');
                confidenceDiv.innerHTML = `<span class="${color} font-bold">${score}% Confidence</span>`;

                analysisDiv.innerHTML = `
                    <div class="font-semibold text-purple-900 mb-1">AI Analysis:</div>
                    <p class="mb-2">${result.analysis}</p>
                    ${result.missing_evidence ? `<div class="font-semibold text-purple-900 mt-2">Missing Evidence:</div><p>${result.missing_evidence}</p>` : ''}
                    ${result.follow_up_questions ? `
                        <div class="font-semibold text-purple-900 mt-2">Suggested Follow-ups:</div>
                        <ul class="list-disc pl-4 mt-1">
                            ${result.follow_up_questions.map(fq => `<li>${fq}</li>`).join('')}
                        </ul>
                    ` : ''}
                `;
            } catch (error) {
                console.error(error);
                analysisDiv.innerHTML = '<span class="text-red-600">Analysis failed. Check API key.</span>';
            }
        }

        // Hardcoded Texas Case Law (Subset)
        const TEXAS_CASE_LAW = [
            { caseName: "Reagor v. NCTCOG", claim: "Retaliation", relevance: "Temporal proximity (13 months) establishes retaliation inference", relevanceScore: 95 },
            { caseName: "EEOC v. Wal-Mart", claim: "Disability (Autism)", relevance: "Failure to provide reasonable accommodations for autism = ADA violation", relevanceScore: 92 },
            { caseName: "Reeves v. Sanderson", claim: "Pretext", relevance: "Proof that employer's reason is false is sufficient for liability", relevanceScore: 88 }
        ];

        function getRelevantCases(section) {
            if (section.includes("Retaliation")) return TEXAS_CASE_LAW.filter(c => c.claim === "Retaliation");
            if (section.includes("Disability")) return TEXAS_CASE_LAW.filter(c => c.claim.includes("Disability"));
            if (section.includes("Termination")) return TEXAS_CASE_LAW.filter(c => c.claim === "Pretext");
            return [];
        }

        function slugify(text) {
            return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        }

        function toggleSection(header) {
            header.nextElementSibling.classList.toggle('hidden');
        }

        function expandAll() { document.querySelectorAll('.divide-y').forEach(el => el.classList.remove('hidden')); }
        function collapseAll() { document.querySelectorAll('.divide-y').forEach(el => el.classList.add('hidden')); }

        function copyAnswer(id) {
            const q = allQuestions.find(q => q.id == id);
            if (q) { navigator.clipboard.writeText(q.answer); alert('Answer copied!'); }
        }

        function exportData() {
            const exportObj = { questions: allQuestions, discovery: discoveryData };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "legal_case_export.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function generateDiscoveryLetter() {
            const neededIds = Object.keys(discoveryData).filter(id => discoveryData[id].needDiscovery);
            let letter = "DOCUMENT REQUEST LETTER\n\nTo: GAINSCO Legal Dept\nFrom: Joshua Shipman\n\nPlease produce the following documents:\n\n";
            neededIds.forEach((id, idx) => {
                const q = allQuestions.find(q => q.id == id);
                const notes = discoveryData[id].notes || "Relevant to claim.";
                letter += `${idx + 1}. Documents related to: ${q.question}\n   Justification: ${notes}\n\n`;
            });

            const blob = new Blob([letter], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Discovery_Request_Letter.txt';
            link.click();
        }
    </script>
</body>

</html>